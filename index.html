<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guardian AI v4.0.97</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --radius-core: 24px; --radius-inner: 16px; --bg-main: #0d1117; --bg-card: #161b22; --border-low: #30363d; --accent-primary: #2563eb; }
        body { background-color: var(--bg-main) !important; color: #e6edf3; font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 110px; overflow-x: hidden; font-weight: 900; font-style: italic; }
        header { position: sticky; top: 0; z-index: 50; background-color: var(--bg-main); padding: 12px 16px; border-bottom: 1px solid var(--border-low); display: flex; justify-content: space-between; align-items: center; }
        main { padding: 16px; }
        .card-inner { background: rgba(22, 27, 34, 0.6); border: 1px solid var(--border-low); border-radius: var(--radius-inner); }
        .filter-btn { transition: 0.3s; border: 1px solid var(--border-low); color: #8b949e; display: flex; align-items: center; gap: 6px; font-size: 9px; padding: 8px 14px; border-radius: 20px; font-weight: 900; font-style: italic; text-transform: uppercase; white-space: nowrap; }
        .filter-btn.active[data-cat="TUDO"] { background: #2563eb; border-color: #2563eb; color: white; }
        .mobile-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #161b22; border-top: 1px solid var(--border-low); z-index: 100; display: flex; justify-content: space-around; padding: 15px 0; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 9px; color: #8b949e; cursor: pointer; text-transform: uppercase; }
        .nav-item.active { color: var(--accent-primary); }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .rotate-icon { animation: rotate 1s linear infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <header>
        <div class="bg-blue-600 p-2 rounded-xl"><i data-lucide="zap" class="w-5 h-5 text-white fill-white"></i></div>
        <div class="flex gap-2 overflow-x-auto no-scrollbar py-1">
            <div class="flex items-center gap-2 bg-[#161b22] px-3 py-1.5 rounded-full border border-[#30363d] whitespace-nowrap">
                <div id="conn-status" class="w-1.5 h-1.5 rounded-full bg-red-500"></div>
                <span id="market-status-text" class="text-[7px] text-gray-400 uppercase tracking-tighter">OFF</span>
            </div>
            <div class="flex items-center gap-2 bg-[#161b22] px-3 py-1.5 rounded-full border border-[#30363d] whitespace-nowrap"><span class="text-[7px] text-blue-400 uppercase">USD</span><span id="usd-price" class="text-[8px] text-white">R$ 0.00</span></div>
        </div>
    </header>

    <main>
        <section id="sec-home" class="content-section active space-y-4">
            <div class="card-inner p-3 flex justify-between items-center border-l-4 border-blue-600 bg-blue-600/5">
                <div><p class="text-[7px] text-blue-400 uppercase tracking-widest">Sequential SafeGuard</p><p id="safety-status" class="text-[9px] text-white italic">Monitorando Sequence</p></div>
                <div id="loss-indicator" class="flex gap-2">
                    <div id="dot-1" class="w-2.5 h-2.5 rounded-full bg-gray-700 transition-colors"></div>
                    <div id="dot-2" class="w-2.5 h-2.5 rounded-full bg-gray-700 transition-colors"></div>
                </div>
            </div>

            <div class="flex items-center justify-between gap-2 py-1">
                <div class="flex gap-2 overflow-x-auto no-scrollbar">
                    <button onclick="updateFilter('TUDO')" id="btn-TUDO" class="filter-btn active" data-cat="TUDO">Tudo</button>
                    <button onclick="updateFilter('USA')" id="btn-USA" class="filter-btn" data-cat="USA">USA</button>
                    <button onclick="updateFilter('CRIPTO')" id="btn-CRIPTO" class="filter-btn" data-cat="CRIPTO">Cripto</button>
                </div>
                <button id="refresh-btn-main" onclick="triggerGuardianEngine()" class="bg-[#2563eb] p-2 rounded-full flex-shrink-0">
                    <i data-lucide="refresh-cw" class="w-4 h-4 text-white"></i>
                </button>
            </div>
            <div id="signal-container" class="grid grid-cols-1 gap-4"></div>
        </section>
    </main>

    <nav class="mobile-nav">
        <div id="nav-home" onclick="switchTab('home')" class="nav-item active"><i data-lucide="zap"></i><span>Sinais</span></div>
        <div id="nav-wallet" onclick="switchTab('wallet')" class="nav-item"><i data-lucide="wallet"></i><span>Carteira</span></div>
    </nav>

    <script>
        const CONFIG = { url: "https://puwjojeeuvtfzevkvzjd.supabase.co", key: "sb_publishable_o8XZmMMgw5l63TcPRdpmrA_T99K-eDX" };
        let sbClient, currentFilter = 'TUDO';

        async function revalidateNews(ativo, btnId) {
            const icon = document.getElementById(`reload-news-${btnId}`);
            if(icon) icon.classList.add('rotate-icon');
            await triggerGuardianEngine();
            setTimeout(() => { if(icon) icon.classList.remove('rotate-icon'); }, 2000);
        }

        async function fetchLatestSignals() {
            const { data } = await sbClient.from('log_oportunidades').select('*').order('created_at', { ascending: false });
            const container = document.getElementById('signal-container');
            
            if(!data || data.length === 0) { 
                container.innerHTML = `<div class="p-10 text-center card-inner border-dashed border-2 border-[#30363d]"><p class="text-[9px] text-gray-500 uppercase tracking-widest">Aguardando novos ativos...</p></div>`; 
                return; 
            }
            
            container.innerHTML = data.map((item, index) => {
                const isUp = parseFloat(item.take_profit) > parseFloat(item.preco_entrada);
                const hasNews = item.motivo_fato_relevante && item.motivo_fato_relevante.length > 20;
                return `<div class="bg-[#161b22] border border-[#30363d] p-5 rounded-[24px]">
                    <div class="flex justify-between items-start mb-1">
                        <div class="flex flex-col">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl text-white font-black uppercase tracking-tighter">${item.ativo}</span>
                                <div class="${isUp ? 'text-green-500' : 'text-red-500'} font-black italic flex items-center gap-1">
                                    <i data-lucide="${isUp ? 'trending-up' : 'trending-down'}" class="w-3.5 h-3.5"></i>
                                    <span class="text-[10px]">9.2%</span>
                                </div>
                            </div>
                            <span class="text-[7px] text-blue-500 font-black uppercase italic tracking-widest">CONFLUÊNCIA: GRÁFICO + NOTÍCIA</span>
                        </div>
                        <button onclick="revalidateNews('${item.ativo}', ${index})" class="p-1.5 bg-black/40 rounded-lg border border-white/5">
                            <i id="reload-news-${index}" data-lucide="rotate-cw" class="w-3 h-3 text-blue-400"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-4 mt-2 bg-black/20 p-3 rounded-xl border border-white/5 text-center">
                        <div class="flex flex-col"><span class="text-[6px] text-gray-500 uppercase">Entrada</span><span class="text-[9px] text-white font-black">${item.preco_entrada}</span></div>
                        <div class="flex flex-col"><span class="text-[6px] text-green-500 uppercase">Alvo</span><span class="text-[9px] text-green-400 font-black">${item.take_profit}</span></div>
                        <div class="flex flex-col"><span class="text-[6px] text-red-500 uppercase">Stop</span><span class="text-[9px] text-red-400 font-black">${item.stop_loss}</span></div>
                    </div>
                    <p class="text-[10px] text-gray-400 leading-tight mb-4 italic font-black">"${item.motivo_fato_relevante || 'Processando notícias de mercado...'}"</p>
                    <div class="flex justify-between items-center pt-3 border-t border-white/5">
                        <div class="px-2 py-1 bg-blue-500/10 text-blue-400 text-[7px] rounded-md uppercase font-black">${item.fonte}</div>
                        <button class="bg-[#2563eb] text-white text-[9px] px-6 py-2 rounded-full font-black italic">EXECUTAR</button>
                    </div>
                </div>`;
            }).join(''); lucide.createIcons();
        }

        async function init() {
            sbClient = supabase.createClient(CONFIG.url, CONFIG.key);
            lucide.createIcons(); await fetchLatestSignals();
            sbClient.channel('sync').on('postgres_changes', { event: '*', schema: 'public' }, () => { fetchLatestSignals(); }).subscribe();
        }
        window.onload = init;
    </script>
</body>
</html>

<script>
  const CONFIG = { 
    url: "https://puwjojeeuvtfzevkvzjd.supabase.co", 
    key: "sb_publishable_o8XZmMMgw5l63TcPRdpmrA_T99K-eDX" 
  };

  // ... mantém o resto do seu código ...

  window.triggerGuardianEngine = async function() {
    const wrapper = document.getElementById('refresh-wrapper');
    const icon = document.getElementById('refresh-icon');
    if(!wrapper || wrapper.classList.contains('loading')) return;

    wrapper.classList.add('loading');

    try {
      const response = await fetch(`${CONFIG.url}/functions/v1/guardian-engine`, { 
        method: 'POST',
        headers: { 
          // ✅ CORRETO PARA EDGE FUNCTIONS (evita 403 no GitHub Pages)
          'apikey': CONFIG.key,
          'Authorization': `Bearer ${CONFIG.key}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
          // ✅ seu backend espera symbol (ou usa BTCUSDT por padrão)
          symbol: "BTCUSDT",
          force_refresh: true 
        })
      });

      // ✅ se der erro HTTP, mostra no console pra você não ficar no escuro
      if (!response.ok) {
        const txt = await response.text().catch(() => "");
        console.error("Edge Function HTTP Error:", response.status, txt);
        wrapper.classList.remove('loading');
        return;
      }

      const data = await response.json().catch(() => ({}));

      if (data.status === "success" || data.status === "aborted") {
        wrapper.classList.remove('loading');
        wrapper.classList.add('success');

        icon.setAttribute('data-lucide', 'check');
        icon.classList.add('text-white');
        lucide.createIcons();

        setTimeout(() => {
          wrapper.classList.remove('success');
          icon.setAttribute('data-lucide', 'refresh-cw');
          icon.classList.remove('text-white');
          lucide.createIcons();
          fetchLatestSignals(); 
          fetchBanca();
        }, 1500);

      } else {
        console.warn("Edge Function returned:", data);
        wrapper.classList.remove('loading');
      }

    } catch(e) {
      console.error("Edge Function call failed:", e);
      wrapper.classList.remove('loading');
    }
  };
</script>
